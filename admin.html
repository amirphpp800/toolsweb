<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ† | TooLs</title>
  <link rel="stylesheet" href="/assets/css/style.css" />
</head>
<body>
  <header class="nav admin-nav"><div class="nav-inner"><div class="brand">TooLs Admin</div><a class="link" href="/">Ø¨Ø§Ø²Ú¯Ø´Øª</a></div></header>
  <main class="section">
    <h2>Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø§Ø¯Ù…ÛŒÙ†</h2>

    <!-- System Status (Always Visible) -->
    <section class="glass card" style="margin-bottom:20px">
      <h3 style="margin-top:0">ğŸ” ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒØ³ØªÙ…</h3>
      <div class="status-overview">
        <div class="status-grid">
          <div class="status-item">
            <div class="status-icon">ğŸ—„ï¸</div>
            <div class="status-info">
              <h4>Ø§ØªØµØ§Ù„ KV</h4>
              <span id="public-kv-pill" class="pill">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ...</span>
            </div>
          </div>
          <div class="status-item">
            <div class="status-icon">âš™ï¸</div>
            <div class="status-info">
              <h4>Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ</h4>
              <span id="public-config-pill" class="pill">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ...</span>
            </div>
          </div>
          <div class="status-item">
            <div class="status-icon">ğŸŒ</div>
            <div class="status-info">
              <h4>Ø³Ø±ÙˆÛŒØ³</h4>
              <span id="public-service-pill" class="pill">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ...</span>
            </div>
          </div>
        </div>
        <div class="status-message" id="status-message">
          <p class="muted">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒØ³ØªÙ…...</p>
        </div>
      </div>
    </section>

    <section id="admin-auth" class="glass card" style="margin-bottom:16px">
      <h3 style="margin-top:0">ÙˆØ±ÙˆØ¯ Ø§Ø¯Ù…ÛŒÙ†</h3>
      <div class="form">
        <label>Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ
          <input id="auser" placeholder="admin" />
        </label>
        <label>Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±
          <input id="apass" type="password" placeholder="******" />
        </label>
        <div class="form-actions">
          <button class="btn primary" id="btnAdminLogin">ÙˆØ±ÙˆØ¯</button>
          <button class="btn" id="btnAdminLogout" style="display:none">Ø®Ø±ÙˆØ¬</button>
        </div>
        <div id="amsg" class="msg"></div>
      </div>
    </section>

    <section id="admin-dash" class="glass card" style="display:none">
      <p class="muted" style="margin:0 0 20px">Ù†Ù…Ø§ÛŒØ´ Ø®Ù„Ø§ØµÙ‡ ÙˆØ¶Ø¹ÛŒØª Ø³Ø±ÙˆÛŒØ³ Ùˆ Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ</p>
      
      <!-- System Status -->
      <div class="status-section">
        <h3 style="margin-bottom: 16px; color: var(--white); border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px;">ğŸ”§ ÙˆØ¶Ø¹ÛŒØª Ø³ÛŒØ³ØªÙ…</h3>
        <div class="dash-grid">
          <div class="dash-card">
            <div class="status-header">
              <h4>ğŸ—„ï¸ Ø§ØªØµØ§Ù„ KV</h4>
              <span id="kv-pill" class="pill">â€”</span>
            </div>
            <p class="status-desc">ÙˆØ¶Ø¹ÛŒØª Ø§ØªØµØ§Ù„ Ø¨Ù‡ Cloudflare KV</p>
          </div>
          <div class="dash-card">
            <div class="status-header">
              <h4>ğŸ‘¤ Ø§Ø¯Ù…ÛŒÙ†</h4>
              <span id="admin-pill" class="pill">â€”</span>
            </div>
            <p class="status-desc">ÙˆØ¶Ø¹ÛŒØª Ù¾ÛŒÚ©Ø±Ø¨Ù†Ø¯ÛŒ Ø­Ø³Ø§Ø¨ Ø§Ø¯Ù…ÛŒÙ†</p>
          </div>
          <div class="dash-card">
            <div class="status-header">
              <h4>ğŸŒ Ø³Ø±ÙˆÛŒØ³</h4>
              <span id="svc-pill" class="pill">â€”</span>
            </div>
            <p class="status-desc">ÙˆØ¶Ø¹ÛŒØª Ú©Ù„ÛŒ Ø³Ø±ÙˆÛŒØ³</p>
          </div>
          <div class="dash-card">
            <div class="status-header">
              <h4>ğŸ‘¥ Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</h4>
              <div id="users-count" class="user-count">â€”</div>
            </div>
            <p class="status-desc">ØªØ¹Ø¯Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø´Ø¯Ù‡</p>
          </div>
        </div>
      </div>

      <!-- Environment Variables Status -->
      <div class="status-section">
        <h3 style="margin: 24px 0 16px; color: var(--white); border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px;">âš™ï¸ Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­ÛŒØ·ÛŒ (ENV)</h3>
        <div class="dash-grid">
          <div class="dash-card">
            <div class="status-header">
              <h4>ğŸ”‘ ADMIN_USER</h4>
              <span id="admin-user-pill" class="pill">â€”</span>
            </div>
            <p class="status-desc">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ø§Ø¯Ù…ÛŒÙ†</p>
          </div>
          <div class="dash-card">
            <div class="status-header">
              <h4>ğŸ” ADMIN_PASS</h4>
              <span id="admin-pass-pill" class="pill">â€”</span>
            </div>
            <p class="status-desc">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± Ø§Ø¯Ù…ÛŒÙ†</p>
          </div>
          <div class="dash-card">
            <div class="status-header">
              <h4>ğŸ”’ JWT_SECRET</h4>
              <span id="jwt-secret-pill" class="pill">â€”</span>
            </div>
            <p class="status-desc">Ú©Ù„ÛŒØ¯ Ø±Ù…Ø²Ù†Ú¯Ø§Ø±ÛŒ JWT</p>
          </div>
          <div class="dash-card">
            <div class="status-header">
              <h4>ğŸ“Š KV Binding</h4>
              <span id="kv-binding-pill" class="pill">â€”</span>
            </div>
            <p class="status-desc">Ø§ØªØµØ§Ù„ Ø¨Ù‡ KV Database</p>
          </div>
        </div>
      </div>

      <!-- Quick Setup Guide -->
      <div class="setup-guide" id="setup-guide" style="display:none">
        <h3 style="margin: 24px 0 16px; color: var(--white); border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px;">ğŸš€ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø³Ø±ÛŒØ¹</h3>
        <div class="guide-card glass">
          <h4>Ø¨Ø±Ø§ÛŒ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ú©Ø§Ù…Ù„ Ø³ÛŒØ³ØªÙ…:</h4>
          <ol class="setup-steps">
            <li>Ø¯Ø± ÙØ§ÛŒÙ„ <code>wrangler.toml</code> Ø¨Ø®Ø´ KV binding Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯</li>
            <li>Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­ÛŒØ·ÛŒ Ø±Ø§ Ø¯Ø± Cloudflare Dashboard ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯</li>
            <li>Ø¯Ø³ØªÙˆØ± <code>wrangler deploy</code> Ø±Ø§ Ø§Ø¬Ø±Ø§ Ú©Ù†ÛŒØ¯</li>
            <li>ØµÙØ­Ù‡ Ø±Ø§ Ø±ÙØ±Ø´ Ú©Ù†ÛŒØ¯ ØªØ§ ØªØºÛŒÛŒØ±Ø§Øª Ø§Ø¹Ù…Ø§Ù„ Ø´ÙˆØ¯</li>
          </ol>
          <div class="env-example">
            <h5>Ù…Ø«Ø§Ù„ Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­ÛŒØ·ÛŒ:</h5>
            <pre><code>ADMIN_USER=admin
ADMIN_PASS=your_secure_password
JWT_SECRET=your_jwt_secret_key</code></pre>
          </div>
        </div>
      </div>
      <!-- Actions -->
      <div class="admin-actions">
        <h3 style="margin: 24px 0 16px; color: var(--white); border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px;">ğŸ› ï¸ Ø¹Ù…Ù„ÛŒØ§Øª Ù…Ø¯ÛŒØ±ÛŒØªÛŒ</h3>
        <div class="action-buttons">
          <button class="btn primary" id="btnRefresh">ğŸ”„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙˆØ¶Ø¹ÛŒØª</button>
          <button class="btn" id="btnList">ğŸ‘¥ Ø¯Ø±ÛŒØ§ÙØª Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</button>
          <button class="btn ghost" id="btnClearCache">ğŸ—‘ï¸ Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ø´</button>
        </div>
      </div>
      
      <!-- Output Area -->
      <div class="output-section" style="margin-top: 20px;">
        <pre id="out" class="output-area"></pre>
      </div>
    </section>
  </main>
  <script>
    const $ = (id) => document.getElementById(id);
    const msg = (t, type='') => { const el = $('amsg'); el.textContent = t || ''; el.style.color = type==='err' ? '#ff6b6b' : '#a0e7a0'; };
    async function api(path, opts={}){
      const res = await fetch(path, { headers:{'Content-Type':'application/json', ...(opts.headers||{})}, credentials:'include', ...opts });
      const text = await res.text(); let data; try{ data = text? JSON.parse(text):{} } catch { data = { raw:text } }
      if(!res.ok) throw Object.assign(new Error(data?.error||res.statusText), { status:res.status, data });
      return data;
    }
    async function refresh(){
      try{
        const st = await api('/api/admin/status');
        const authed = !!st.authed;
        $('admin-auth').style.display = authed ? 'none' : '';
        $('admin-dash').style.display = authed ? '' : 'none';
        
        // System Status
        const kv = st.kv === 'connected';
        $('kv-pill').className = 'pill ' + (kv ? 'ok':'bad');
        $('kv-pill').textContent = kv ? 'Ù…ØªØµÙ„' : 'Ù‚Ø·Ø¹';
        
        $('admin-pill').className = 'pill ' + (st.adminConfigured ? 'ok':'bad');
        $('admin-pill').textContent = st.adminConfigured ? 'Ø¢Ù…Ø§Ø¯Ù‡' : 'Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙ†Ø¸ÛŒÙ…';
        
        $('users-count').textContent = st.userCount ?? 0;
        
        const serviceOk = kv && st.adminConfigured;
        $('svc-pill').className = 'pill ' + (serviceOk ? 'ok':'warn');
        $('svc-pill').textContent = serviceOk ? 'Ø¹Ù…Ù„ÛŒØ§ØªÛŒ' : 'Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙ†Ø¸ÛŒÙ…';
        
        // Environment Variables Status
        const env = st.env || {};
        
        $('admin-user-pill').className = 'pill ' + (env.ADMIN_USER ? 'ok':'bad');
        $('admin-user-pill').textContent = env.ADMIN_USER ? 'ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡' : 'ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡';
        
        $('admin-pass-pill').className = 'pill ' + (env.ADMIN_PASS ? 'ok':'bad');
        $('admin-pass-pill').textContent = env.ADMIN_PASS ? 'ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡' : 'ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡';
        
        $('jwt-secret-pill').className = 'pill ' + (env.JWT_SECRET ? 'ok':'bad');
        $('jwt-secret-pill').textContent = env.JWT_SECRET ? 'ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡' : 'ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡';
        
        $('kv-binding-pill').className = 'pill ' + (st.kvBinding ? 'ok':'bad');
        $('kv-binding-pill').textContent = st.kvBinding ? 'Ù…ØªØµÙ„' : 'Ù‚Ø·Ø¹';
        
        // Show setup guide if not fully configured
        const needsSetup = !env.ADMIN_USER || !env.ADMIN_PASS || !env.JWT_SECRET || !st.kvBinding;
        $('setup-guide').style.display = needsSetup ? '' : 'none';
        
        $('btnAdminLogout').style.display = authed ? '' : 'none';
      }catch{
        // if status fails, show auth
        $('admin-auth').style.display = '';
        $('admin-dash').style.display = 'none';
      }
    }
    async function adminLogin(){
      msg('');
      try{
        await api('/api/admin/login', { method:'POST', body: JSON.stringify({ username: $('auser').value.trim(), password: $('apass').value }) });
        msg('ÙˆØ±ÙˆØ¯ Ù…ÙˆÙÙ‚');
        await refresh();
      }catch(err){ msg('Ø¹Ø¯Ù… Ø¯Ø³ØªØ±Ø³ÛŒ', 'err'); }
    }
    async function adminLogout(){
      try{ await api('/api/admin/logout', { method:'POST' }); }catch{}
      await refresh();
    }
    async function listUsers(){
      try{
        const data = await api('/api/admin/users');
        $('out').textContent = JSON.stringify(data, null, 2);
      }catch(err){ $('out').textContent = 'Ø¹Ø¯Ù… Ø¯Ø³ØªØ±Ø³ÛŒ ÛŒØ§ Ø®Ø·Ø§'; }
    }
    async function clearCache(){
      try{
        await api('/api/admin/clear-cache', { method:'POST' });
        $('out').textContent = 'Ú©Ø´ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø§Ú© Ø´Ø¯';
        await refresh();
      }catch(err){ $('out').textContent = 'Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ú©Ø´: ' + err.message; }
    }
    
    $('btnAdminLogin').addEventListener('click', adminLogin);
    $('btnAdminLogout').addEventListener('click', adminLogout);
    $('btnList').addEventListener('click', listUsers);
    $('btnRefresh').addEventListener('click', refresh);
    $('btnClearCache').addEventListener('click', clearCache);
    // Load public status on page load (before login)
    async function loadPublicStatus(){
      try{
        const st = await api('/api/admin/status');
        
        // Update public status indicators
        const kv = st.kv === 'connected';
        $('public-kv-pill').className = 'pill ' + (kv ? 'ok':'bad');
        $('public-kv-pill').textContent = kv ? 'Ù…ØªØµÙ„' : 'Ù‚Ø·Ø¹';
        
        const configured = st.adminConfigured;
        $('public-config-pill').className = 'pill ' + (configured ? 'ok':'bad');
        $('public-config-pill').textContent = configured ? 'ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡' : 'Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙ†Ø¸ÛŒÙ…';
        
        const serviceOk = kv && configured;
        $('public-service-pill').className = 'pill ' + (serviceOk ? 'ok':'warn');
        $('public-service-pill').textContent = serviceOk ? 'Ø¹Ù…Ù„ÛŒØ§ØªÛŒ' : 'Ù†ÛŒØ§Ø² Ø¨Ù‡ ØªÙ†Ø¸ÛŒÙ…';
        
        // Update status message
        const messageEl = $('status-message');
        if(serviceOk){
          messageEl.innerHTML = '<p class="success-text">âœ“ Ø³ÛŒØ³ØªÙ… Ø¢Ù…Ø§Ø¯Ù‡ Ø¹Ù…Ù„ÛŒØ§Øª Ø§Ø³Øª</p>';
        } else if(!kv){
          messageEl.innerHTML = '<p class="error-text">âš ï¸ Ø§ØªØµØ§Ù„ KV Ø¨Ø±Ù‚Ø±Ø§Ø± Ù†ÛŒØ³Øª - Ù„Ø·ÙØ§Ù‹ KV binding Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯</p>';
        } else if(!configured){
          messageEl.innerHTML = '<p class="warning-text">âš ï¸ Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ù…Ø­ÛŒØ·ÛŒ ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯</p>';
        }
      }catch{
        // If status API fails, show connection error
        $('public-kv-pill').className = 'pill bad';
        $('public-kv-pill').textContent = 'Ø®Ø·Ø§';
        $('public-config-pill').className = 'pill bad';
        $('public-config-pill').textContent = 'Ø®Ø·Ø§';
        $('public-service-pill').className = 'pill bad';
        $('public-service-pill').textContent = 'Ø®Ø·Ø§';
        $('status-message').innerHTML = '<p class="error-text">âš ï¸ Ø¹Ø¯Ù… Ø¯Ø³ØªØ±Ø³ÛŒ Ø¨Ù‡ API - Ù„Ø·ÙØ§Ù‹ Ø§ØªØµØ§Ù„ Ø´Ø¨Ú©Ù‡ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯</p>';
      }
    }
    
    window.addEventListener('DOMContentLoaded', () => {
      loadPublicStatus();
      refresh();
    });
  </script>
</body>
</html>
